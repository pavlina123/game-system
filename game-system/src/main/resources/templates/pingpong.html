<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üéæ –ü–∏–Ω-–ü–æ–Ω–≥ - ‚ö° PULSE PONG</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
          font-family: 'Orbitron', sans-serif;
          background: linear-gradient(135deg, #0a0a1a, #200020); /* –ì–ª—É–±–æ–∫–∏–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω */
          color: #00ffff;
          text-align: center;
          margin: 0;
          padding: 20px;
        }
        h1 {
            color: #ff00ff; /* –ü—É—Ä–ø—É—Ä–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
            margin-bottom: 15px;
            text-shadow: 0 0 15px rgba(255, 0, 255, 0.8);
            letter-spacing: 2px;
        }
        #game-area {
          width: 600px;
          height: 400px;
          background: #0d0d1a; /* –¢–µ–º–Ω—ã–π, –ø–æ—á—Ç–∏ —á–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
          border: 3px solid #00ffff; /* –¶–∏–∞–Ω–æ–≤–∞—è —Ä–∞–º–∫–∞ */
          border-radius: 5px;
          margin: 20px auto;
          box-shadow: 0 0 40px rgba(0, 255, 255, 0.6);
          position: relative;
        }
        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Ç–∫–∞ –Ω–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ */
        #game-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, transparent, transparent 19px, #1a1a33 20px),
                        repeating-linear-gradient(90deg, transparent, transparent 19px, #1a1a33 20px);
            opacity: 0.2;
            z-index: 0;
            pointer-events: none;
        }
        #start-button, #play-button {
          background: #ff00ff; /* –ü—É—Ä–ø—É—Ä–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
          color: white;
          padding: 15px 30px;
          font-size: 20px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          margin-top: 15px;
          font-family: 'Orbitron', sans-serif;
          text-transform: uppercase;
          box-shadow: 0 0 20px rgba(255, 0, 255, 0.7);
          transition: all 0.3s;
        }
        #start-button:hover, #play-button:hover {
            background: #ff40ff;
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 64, 255, 1);
        }
        #status {
          margin-top: 15px;
          font-size: 16px;
          color: #fff;
          text-shadow: 0 0 8px #00ffff;
        }
    </style>
</head>
<body>

<h1>PULSE PONG // ARDUINO INTERFACE</h1>
<div id="game-area">
    <canvas id="pong" width="600" height="400"></canvas>
</div>

<button id="start-button">CONNECT ARDUINO INTERFACE</button>
<button id="play-button" style="display:none;">INITIATE PULSE</button>

<div id="status">STATUS: AWAITING CONNECTION...</div>

<script>
    // --- üé∂ –ê–£–î–ò–û –ö–û–ù–¢–ï–ö–°–¢ üé∂ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playPaddleHitSound() {
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);

        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ –∞—Ä–¥—É–∏–Ω–æ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —É–¥–∞—Ä–∞
        sendPaddleHitToArduino();
    }

    function playWallHitSound() {
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        osc.type = 'sine';
        osc.frequency.setValueAtTime(400, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);

        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.08);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.08);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ –∞—Ä–¥—É–∏–Ω–æ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —É–¥–∞—Ä–∞ –æ —Å—Ç–µ–Ω—É
        sendWallHitToArduino();
    }

    function playScoreSound() {
        const notes = [600, 800, 1000];
        const duration = 0.15;
        let time = audioCtx.currentTime;

        notes.forEach((freq, index) => {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            osc.type = 'square';

            gainNode.gain.setValueAtTime(0.02, time + index * duration * 1.2);
            gainNode.gain.linearRampToValueAtTime(0.2, time + index * duration * 1.2 + 0.05);
            gainNode.gain.linearRampToValueAtTime(0.001, time + (index * duration * 1.2) + duration);

            osc.frequency.setValueAtTime(freq, time + index * duration * 1.2);
            osc.start(time + index * duration * 1.2);
            osc.stop(time + (index * duration * 1.2) + duration);
        });

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ –∞—Ä–¥—É–∏–Ω–æ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —Å—á–µ—Ç–∞
        sendScoreSoundToArduino();
    }

    function playGameOverSound() {
        const notes = [300, 250, 200, 150];
        const duration = 0.3;
        let time = audioCtx.currentTime;

        notes.forEach((freq, index) => {
            const osc = audioCtx.createOscillator();
            osc.connect(audioCtx.destination);
            osc.type = 'sawtooth';

            osc.frequency.setValueAtTime(freq, time + index * duration * 1.5);
            osc.start(time + index * duration * 1.5);
            osc.stop(time + (index * duration * 1.5) + duration);
        });

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ –∞—Ä–¥—É–∏–Ω–æ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ –ø—Ä–æ–∏–≥—Ä—ã—à–∞
        sendGameOverToArduino();
    }
    // ------------------------------------

    let port, reader, writer;
    const canvas = document.getElementById("pong");
    const ctx = canvas.getContext("2d");
    const statusDiv = document.getElementById("status");
    let gameRunning = false;

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã
    let paddleHeight = 80;
    let paddleY = 160;
    let ballRadius = 8; // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–¥–∏—É—Å –º—è—á–∞
    let paddleWidth = 10; // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —à–∏—Ä–∏–Ω—É —Ä–∞–∫–µ—Ç–∫–∏
    let ballX = 300, ballY = 200, ballDX = 4, ballDY = 4;
    let score = 0;

    function drawGame() {
      // –û—á–∏—Å—Ç–∫–∞ —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å CSS —Å–µ—Ç–∫—É
      ctx.fillStyle = "rgba(13, 13, 26, 0.1)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // --- –†–∏—Å—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω—É—é –ª–∏–Ω–∏—é ---
      ctx.strokeStyle = '#00ffff';
      ctx.lineWidth = 2;
      ctx.setLineDash([10, 10]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();
      ctx.setLineDash([]); // –°–±—Ä–æ—Å

      // --- –†–∞–∫–µ—Ç–∫–∞: –ó–∞—â–∏—Ç–Ω—ã–π –©–∏—Ç (–©–∏—Ç –≤—Å–µ–≥–¥–∞ —Ü–∏–∞–Ω–æ–≤—ã–π) ---
      ctx.fillStyle = "#00ffff";
      ctx.shadowColor = "#00ffff";
      ctx.shadowBlur = 15;
      ctx.fillRect(20, paddleY, paddleWidth, paddleHeight);
      ctx.shadowBlur = 0; // –°–±—Ä–æ—Å —Ç–µ–Ω–∏

      // --- –ú—è—á: –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ò–º–ø—É–ª—å—Å (–ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π –ø—É—Ä–ø—É—Ä–Ω—ã–π) ---
      ctx.beginPath();
      ctx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
      ctx.fillStyle = "#ff00ff";
      ctx.shadowColor = "#ff00ff";
      ctx.shadowBlur = 20;
      ctx.fill();
      ctx.shadowBlur = 0; // –°–±—Ä–æ—Å —Ç–µ–Ω–∏

      // --- –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ (–í–∏–∑—É–∞–ª—å–Ω—ã–π –±–∞—Ä—å–µ—Ä) ---
      ctx.fillStyle = "rgba(255, 0, 255, 0.3)";
      ctx.fillRect(canvas.width - 10, 0, 10, canvas.height);


      // --- –°—á—ë—Ç: –°—Ç–∏–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ ---
      ctx.fillStyle = "#ff00ff";
      ctx.font = "bold 24px Orbitron";
      ctx.shadowColor = "#ff00ff";
      ctx.shadowBlur = 10;
      ctx.textAlign = "right";
      ctx.fillText("SCORE: " + score, 590, 30);
      ctx.shadowBlur = 0; // –°–±—Ä–æ—Å —Ç–µ–Ω–∏
    }

    function updateGame() {
      if (!gameRunning) return;

      // 1. –î–≤–∏–∂–µ–Ω–∏–µ –º—è—á–∞
      ballX += ballDX;
      ballY += ballDY;

      // 2. –û—Ç—Å–∫–æ–∫ –æ—Ç –≤–µ—Ä—Ö–Ω–µ–π –∏ –Ω–∏–∂–Ω–µ–π —Å—Ç–µ–Ω—ã
      if (ballY - ballRadius <= 0 || ballY + ballRadius >= canvas.height) {
          ballDY *= -1;
          playWallHitSound(); // –ó–≤—É–∫ —É–¥–∞—Ä–∞ –æ —Å—Ç–µ–Ω—É
      }

      // 3. –û–¢–°–ö–û–ö –û–¢ –ü–†–ê–í–û–ô –°–¢–ï–ù–´ (–ò–°–ü–†–ê–í–õ–ï–ù–û - –ú–Ø–ß –ù–ï –£–õ–ï–¢–ê–ï–¢ –í–ü–†–ê–í–û)
      // –ï—Å–ª–∏ –º—è—á –¥–æ—à—ë–ª –¥–æ –ø—Ä–∞–≤–æ–π —Å—Ç–µ–Ω—ã, –æ–Ω –æ—Ç—Å–∫–∞–∫–∏–≤–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ.
      if (ballX + ballRadius >= canvas.width - paddleWidth) { // - paddleWidth, —á—Ç–æ–±—ã –æ—Ç—Å–∫–∞–∫–∏–≤–∞–ª –æ—Ç —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–π –ø–æ–ª–æ—Å—ã
          ballDX *= -1;
          playWallHitSound(); // –ó–≤—É–∫ —É–¥–∞—Ä–∞ –æ —Å—Ç–µ–Ω—É
      }


      // 4. –û–¢–°–ö–û–ö –û–¢ –†–ê–ö–ï–¢–ö–ò
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Ä–∞–∫–µ—Ç–∫–æ–π (–ª–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)
      if (
          ballX - ballRadius <= 20 + paddleWidth && // –õ–µ–≤—ã–π –∫—Ä–∞–π –º—è—á–∞ –∫–∞—Å–∞–µ—Ç—Å—è –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è —Ä–∞–∫–µ—Ç–∫–∏
          ballY + ballRadius > paddleY &&          // –ú—è—á –Ω–∏–∂–µ –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∫–µ—Ç–∫–∏
          ballY - ballRadius < paddleY + paddleHeight && // –ú—è—á –≤—ã—à–µ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∫–µ—Ç–∫–∏
          ballDX < 0 // –ú—è—á –¥–≤–∏–∂–µ—Ç—Å—è –≤–ª–µ–≤–æ
      ) {
          // –û—Ç—Å–∫–æ–∫
          ballDX *= -1.05; // –£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å–∫–æ–∫–µ
          score++;

          playPaddleHitSound(); // –ó–≤—É–∫ —É–¥–∞—Ä–∞ –æ —Ä–∞–∫–µ—Ç–∫—É
          playScoreSound(); // –ó–≤—É–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—á–∫–∞

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–¥–ª—è –æ—Ç—á–µ—Ç–∞)
          let currentPoints = parseInt(localStorage.getItem("userPoints") || '0');
          localStorage.setItem("userPoints", currentPoints + 1);

          sendScore(score);
      }

      // 5. –ü—Ä–æ–∏–≥—Ä—ã—à (–º—è—á —É–ª–µ—Ç–µ–ª –≤–ª–µ–≤–æ, –∑–∞ —Ä–∞–∫–µ—Ç–∫—É)
      if (ballX - ballRadius < 0) {
          playGameOverSound(); // –ó–≤—É–∫ –ø—Ä–æ–∏–≥—Ä—ã—à–∞
          sendLose();
          gameOver();
          return;
      }

      drawGame();
      requestAnimationFrame(updateGame);
    }

    function gameOver() {
      gameRunning = false;
      ctx.fillStyle = "#ff0000";
      ctx.font = "40px Orbitron";
      ctx.shadowColor = "#ff0000";
      ctx.shadowBlur = 20;
      ctx.textAlign = "center";
      ctx.fillText("INTERFACE CRITICAL FAILURE", canvas.width / 2, canvas.height / 2);
      ctx.shadowBlur = 0;
      document.getElementById("play-button").style.display = "block";
    }

    function startGame() {
      score = 0;
      // –°–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏ –∏ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏. –ú—è—á –¥–æ–ª–∂–µ–Ω –ª–µ—Ç–µ—Ç—å –≤ —Å—Ç–æ—Ä–æ–Ω—É —Ä–∞–∫–µ—Ç–∫–∏, —Ç–æ –µ—Å—Ç—å –≤–ª–µ–≤–æ (ballDX < 0).
      ballX = 300; ballY = 200;
      ballDX = -4; ballDY = 4; // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π DX, —á—Ç–æ–±—ã –º—è—á –ª–µ—Ç–µ–ª –∫ —Ä–∞–∫–µ—Ç–∫–µ
      paddleY = 160;
      document.getElementById("play-button").style.display = "none";
      gameRunning = true;
      sendReset();
      updateGame();
    }

    // === –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Arduino ===
    async function connectToArduino() {
      if (!('serial' in navigator)) {
        statusDiv.textContent = "‚ùå WEB SERIAL API UNAVAILABLE.";
        return;
      }
      try {
        port = await navigator.serial.requestPort();
        // –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Arduino –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ 115200
        await port.open({ baudRate: 115200 });

        const decoder = new TextDecoderStream();
        const readableStream = port.readable.pipeThrough(decoder);
        reader = readableStream.getReader();

        const encoder = new TextEncoderStream();
        encoder.readable.pipeTo(port.writable);
        writer = encoder.writable.getWriter();

        statusDiv.textContent = "‚úÖ ARDUINO PROTOCOL ACTIVE!";
        document.getElementById("start-button").style.display = "none";
        document.getElementById("play-button").style.display = "block";
        readArduinoData();
      } catch (error) {
        statusDiv.textContent = "[CONNECTION ERROR]: " + error;
      }
    }

    async function readArduinoData() {
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        // –í Arduino –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: "joyX,joyY\n"
        if (value) processInput(value.trim());
      }
    }

    function processInput(data) {
      // –í–ê–ñ–ù–û: –ï—Å–ª–∏ Arduino –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —á–∏—Å–ª–æ (JoyY), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
      // const joyY = Number(data);
      // –ï—Å–ª–∏ Arduino –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: "512,100\n", –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
      const parts = data.split(",");
      if (parts.length < 2) return; // –£–±—Ä–∞–ª –ø—Ä–æ–≤–µ—Ä–∫—É < 3
      const [, joyY] = parts.map(Number); // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ JoyY (–≤—Ç–æ—Ä–æ–µ —á–∏—Å–ª–æ)

      const speed = 10;

      // –î–≤–∏–∂–µ–Ω–∏–µ —Ä–∞–∫–µ—Ç–∫–∏
      if (joyY < 400 && paddleY > 0) paddleY -= speed; // –î–≤–∏–∂–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö
      if (joyY > 600 && paddleY + paddleHeight < canvas.height) paddleY += speed; // –î–≤–∏–∂–µ–Ω–∏–µ –≤–Ω–∏–∑
    }

    // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥ –Ω–∞ Arduino
    async function sendScore(val) {
      if (writer) await writer.write(`SCORE:${val}\n`);
    }

    async function sendPaddleHitToArduino() {
      if (writer) await writer.write("BUZZER_PADDLE\n");
    }

    async function sendWallHitToArduino() {
      if (writer) await writer.write("BUZZER_WALL\n");
    }

    async function sendScoreSoundToArduino() {
      if (writer) await writer.write("BUZZER_SCORE\n");
    }

    async function sendGameOverToArduino() {
      if (writer) await writer.write("BUZZER_LOSE\n");
    }

    async function sendLose() {
      if (writer) await writer.write("LOSE\n");
    }

    async function sendReset() {
      if (writer) await writer.write("RESET\n");
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π (–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) ---
    document.addEventListener('keydown', event => {
        if (!gameRunning) return;
        const speed = 10;
        if (event.key === 'ArrowUp' && paddleY > 0) paddleY -= speed;
        if (event.key === 'ArrowDown' && paddleY + paddleHeight < canvas.height) paddleY += speed;
    });

    document.getElementById("start-button").onclick = connectToArduino;
    document.getElementById("play-button").onclick = startGame;

    drawGame(); // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
</script>
</body>
</html>